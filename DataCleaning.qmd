---
title: "Data Cleaning"
author: "Ashley, Zoey, Vinithra, Hailey"  
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
    code-fold: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

## Data Cleaning

**Loading Required Packages**

```{r}
library(tidyverse)
library(readr)
library(knitr)
library(gganimate)
library(broom)
library(kableExtra)
```

**Life Expectancy Data** 

Here I will load and clean the life expectancy data for the project.I decided to remove all years with missing values, and decrease sample size to around 100 data points. In addition, I also created a separate table of average life expectancy for each country per decade.

```{r}
lex <- read_csv("lex.csv")
lex_long <- lex |>
  select(country,"1950":"2050") |>
  pivot_longer(cols = !country, 
               names_to = "year", 
               values_to = "life_ex")
```


```{r}
avg_lex_decade <- lex |>
  mutate("1950s" = rowMeans(across("1950":"1959"))) |>
  mutate("1960s" = rowMeans(across("1960":"1969"))) |>
  mutate("1970s" = rowMeans(across("1970":"1979"))) |>
  mutate("1980s" = rowMeans(across("1980":"1989"))) |>
  mutate("1990s" = rowMeans(across("1990":"1999"))) |>
  mutate("2000s" = rowMeans(across("2000":"2009"))) |>
  mutate("2010s" = rowMeans(across("2010":"2019"))) |>
  mutate("2020s" = rowMeans(across("2020":"2029"))) |>
  mutate("2030s" = rowMeans(across("2030":"2039"))) |>
  mutate("2040s" = rowMeans(across("2040":"2049"))) |>
  select(1,"1950s":"2040s")
kable(head(avg_lex_decade))
```

**Income Share of Middle 20%**

Loading and cleaning of data for the income share of the poorest 10% by country.

```{r}
income_share_middle <- read_csv("income_share_of_middle_20percent.csv")

income_share_long <- income_share_middle |> 
  pivot_longer(cols = !country, 
               names_to = "year", 
               values_to = "income_share")
```

```{r}
income_share_means <- income_share_middle |> 
  mutate("1960s" = rowMeans(across("1963":"1969")), 
         "1970s" = rowMeans(across("1970":"1979")), 
         "1980s" = rowMeans(across("1980":"1989")), 
         "1990s" = rowMeans(across("1990":"1999")), 
         "2000s" = rowMeans(across("2000":"2009")), 
         "2010s" = rowMeans(across("2010":"2019")), 
         "2020s" = rowMeans(across("2020":"2023"))) |>
  select(1, "1960s":"2020s")

income_share_means |> 
  head(10) |> 
  kable()
```

**Joining the Data Set**

```{r}
joined_data <- left_join(lex_long, 
                         income_share_long, 
                         join_by(country==country,year==year))
```

```{r}
joined_data <- joined_data |>
  filter(!is.na(income_share)) |>
  mutate(year = as.numeric(year))

joined_data |> 
  head(10) |> 
  kable()
```


## Linear Regression

**Visualizing the Relationship Between Life Expectancy and Income Share of the Middle 20% **

```{r}
joined_data |>
  group_by(country) |>
  mutate(life_ex = mean(life_ex)) |>
  mutate(income_share = mean(income_share))|>
  ggplot(aes(x = income_share, 
             y = life_ex
             )
         ) +
  geom_point() +
  geom_smooth(method = "lm") + 
  labs(x = "Income Share of the Middle 20%",
       subtitle = "Life Expectancy(Years)",
       title = "Relationship Between Income Share of the Middle 20%
       and Life Expectancy"
       ) +
  theme(axis.title.y = element_blank())
```

**Creating an Animated Plot of How The Relationship Changes Over Time**

```{r}
library(gifski)
data_anim <- joined_data |> 
  ggplot(aes(x = income_share, y = life_ex)) +
  geom_point(alpha = 0.7, color = "steelblue") +
  labs(y = "Life Expectancy (Years)",
       x = "Income Share of Middle 20%",
       subtitle = "Year: {frame_time}",
       title = "How the Relationship Between Income Share and Life Expectancy Changes Over Time") +
  theme_minimal() +
  theme(plot.subtitle = element_text(size = 14),
        plot.title = element_text(hjust = 0.5)) +
  transition_time(year) +
  ease_aes("linear")



animate(data_anim, nframes = 61, fps = 2, renderer = gifski_renderer("income_life_animation.gif"))

```

**Fitting a SLR Model**

```{r}
data_for_lm <- joined_data |>
  group_by(country) |>
  mutate(life_ex = mean(life_ex)) |>
  mutate(income_share = mean(income_share))
```

```{r}
project_lm <- lm(life_ex ~ income_share, 
                 data = data_for_lm)

kable(broom::tidy(project_lm))
```

This table represents a simple linear regression model of the relationship between *Life Expectancy* and *Income Share of the Middle 20%*. The coefficients shown in the table tell us that if someone's income share is 0, their expected life expectancy is about 50 years. The coefficients also show that for each dollar gained, a person will live about 1.5 years more, on average.

**Model Fit **

```{r}
lm_assess <-broom::augment(project_lm)
r2 <- broom::glance(project_lm)$r.squared
lm_assess |>
  ungroup() |>
  summarize("Variance in Response" = var(life_ex),
            "Variance of Predicted Values" = var(.fitted),
            "Variance of Residuals" = var(.resid),
            RSquared = r2) |>
  kable(caption = "Model Variances and R-Squared", align = "c") |>
  kable_styling(
    position = "center", font_size = 12)
```


As shown in the table above, about 17.57% of variance in life expectancy appears to be explained by income share of the middle 20%. This is fairly large, and though it certainly doesn't seem like a large portion, considering life expectancy is impacted by such a variety of sources, I consider the value we obtained to be impressive.
